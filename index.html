<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Social Media Marketing Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Identity Services (new) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- gapi client (used for the YouTube Data client library) -->
<script src="https://apis.google.com/js/api.js" async defer></script>

<style>
body {font-family:'Roboto',sans-serif; margin:0; background:#f4f6f8; color:#333;}
header {background:#4267B2; color:#fff; padding:25px 20px; text-align:center; font-size:1.6em; font-weight:700; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.container {max-width:1200px; margin:20px auto; padding:0 20px;}
.card {background:#fff; border-radius:12px; padding:18px 22px; margin-bottom:20px; box-shadow:0 6px 20px rgba(0,0,0,0.06);}
.card h3 {margin-top:0; color:#444; margin-bottom:10px; font-size:1.05em;}
button {background:#4267B2; color:#fff; border:none; padding:8px 14px; margin:6px 0; border-radius:6px; cursor:pointer; font-weight:500;}
button:hover {background:#365899;}
textarea,input,select {width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc;}
pre {background:#f0f0f0; padding:12px; border-radius:8px; overflow-x:auto; max-height:260px;}
.status {font-weight:500; margin-bottom:10px;}
.chart-container {position:relative; height:300px; margin-top:15px;}
.section-color-1 {border-left:6px solid #4267B2;}
.section-color-2 {border-left:6px solid #f57c00;}
.section-color-3 {border-left:6px solid #6a1b9a;}
.section-color-4 {border-left:6px solid #00796b;}
.section-color-5 {border-left:6px solid #1DA1F2;}
.section-color-6 {border-left:6px solid #E1306C;}
.section-color-7 {border-left:6px solid #FF0000;}
@media(max-width:600px){header{font-size:1.3em;padding:18px};.card{padding:12px}}
.note {font-size:0.9em;color:#666;margin-top:6px;}
.error {color:#b00020;font-weight:600;}
</style>
</head>
<body>
<header>Social Media Marketing Dashboard</header>
<div class="container">

<!-- FACEBOOK -->
<div class="card section-color-1">
  <h3>üìò Facebook Login</h3>
  <p class="status" id="status">Not logged in.</p>
  <button id="btnLogin">Login with Facebook</button>
  <button id="btnLogout" style="display:none">Logout</button>
  <div class="note">Use this to list pages/ad-accounts and then fetch page/instagram insights.</div>
</div>

<!-- FACEBOOK ADS -->
<div class="card section-color-2">
  <h3>üíº Facebook Ad Accounts & Insights</h3>
  <div id="adAccountsList">Not loaded</div>
  <div id="selectedAdAccount" style="margin:8px 0"></div>
  <button id="btnGetAdInsights">Fetch Ad Insights (last 7 days)</button>
  <pre id="adInsightsResult"></pre>
  <div class="chart-container"><canvas id="adChart"></canvas></div>
</div>

<!-- FACEBOOK PAGES -->
<div class="card section-color-3">
  <h3>üìÉ Facebook Pages</h3>
  <div id="pagesList">Not loaded</div>
</div>

<!-- PAGE ACTIONS -->
<div class="card section-color-4">
  <h3>‚öôÔ∏è Page Actions & Page Insights</h3>
  <div><b>Selected Page:</b> <span id="selectedPageName"></span></div>
  <textarea id="postMessage" placeholder="Post message">Hello from dashboard!</textarea>
  <button id="btnPost">Post to Page</button>
  <pre id="postResult"></pre>
  <select id="insightsMetric">
    <option value="page_fans">Fans</option>
    <option value="page_impressions">Impressions</option>
    <option value="page_engaged_users">Engaged Users</option>
  </select>
  <button id="btnGetPageInsights">Fetch Page Insights (7d)</button>
  <div class="chart-container"><canvas id="pageChart"></canvas></div>
</div>

<!-- INSTAGRAM -->
<div class="card section-color-6">
  <h3>üì∏ Instagram (via connected Page)</h3>
  <button id="btnGetInstagramInfo">Fetch Instagram Info</button>
  <pre id="instaInfo"></pre>
  <input id="instaImageUrl" placeholder="Image URL (for posting)">
  <textarea id="instaCaption" placeholder="Caption">Hello from dashboard!</textarea>
  <button id="btnInstaPost">Create Instagram Media + Publish</button>
  <pre id="instaPostResult"></pre>
  <button id="btnGetInstaInsights">Fetch IG Insights (7d)</button>
  <div class="chart-container"><canvas id="instaChart"></canvas></div>
  <div class="note">Instagram features require the Facebook Page to be linked to an Instagram Business account and the app to have approved permissions.</div>
</div>
<!-- YOUTUBE -->
<div class="card section-color-7">
  <h1>üìä YouTube Ads Upload & Analytics</h1>

  <div class="controls">
    <button id="btnGoogleLogin">Login with Google</button>
    <button id="btnGoogleLogout" style="display:none;">Logout</button>
    <span id="ytStatus">Not logged in</span>
  </div>

  <hr>

  <h3>üé• Upload Your Ad</h3>
  <form id="uploadForm">
    <input type="text" id="title" placeholder="Video Title" required /><br>
    <textarea id="description" placeholder="Description"></textarea><br>
    <select id="privacy">
      <option value="public">Public</option>
      <option value="unlisted">Unlisted</option>
      <option value="private" selected>Private</option>
    </select><br>
    <input type="file" id="videoFile" accept="video/*" required /><br>
    <button type="submit">Upload Video</button>
  </form>
  <pre id="ytUploadResult"></pre>

  <hr>

  <h3>üìà Ad Campaign Metrics</h3>
  <button id="btnFetchMetrics">Fetch Metrics</button>
  <pre id="metricsResult"></pre>

  <canvas id="ytChart" width="400" height="200"></canvas>
</div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</div>

<!-- Facebook SDK -->
<script src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
const FB_APP_ID = '2766175383577129'; // <-- replace with your FB App ID
const GOOGLE_CLIENT_ID = '909323253369-817lthmrt17refrp225q39h4nkqsp2tj.apps.googleusercontent.com'; // <-- replace with your Google Web client ID


const FB_SCOPES = 'public_profile,pages_show_list,pages_manage_posts,pages_read_engagement,ads_read,ads_management,business_management,instagram_basic,instagram_manage_insights,instagram_content_publish';
let userAccessToken=null, pages=[], selectedPage=null, adAccounts=[], selectedAdAccount=null;
let pageChart=null, instaChart=null, twitterChart=null, ytChart=null, adChart=null;

/* ---------------------------
   FACEBOOK: init + helpers
   --------------------------- */
window.fbAsyncInit = function() {
  FB.init({ appId: FB_APP_ID, cookie: true, xfbml: false, version: 'v19.0' });
  FB.getLoginStatus(checkLoginState);
};

function checkLoginState(response) {
  if (response && response.status === 'connected') {
    userAccessToken = response.authResponse.accessToken;
    document.getElementById('btnLogin').style.display='none';
    document.getElementById('btnLogout').style.display='inline-block';
    document.getElementById('status').textContent = '‚úÖ Logged in (Facebook)';
    fetchAdAccounts();
    fetchPages();
  } else {
    document.getElementById('status').textContent = 'Not logged in.';
  }
}

document.getElementById('btnLogin').onclick = () => {
  FB.login(checkLoginState, { scope: FB_SCOPES });
};
document.getElementById('btnLogout').onclick = () => {
  FB.logout(()=> location.reload());
};

// fetch ad accounts
function fetchAdAccounts(){
  document.getElementById('adAccountsList').textContent = 'Loading...';
  FB.api('/me/adaccounts','GET',{access_token:userAccessToken}, r => {
    if (!r || r.error) {
      document.getElementById('adAccountsList').textContent = 'Failed to load ad accounts.';
      console.error('AdAccounts error', r);
      return;
    }
    adAccounts = r.data || [];
    if(!adAccounts.length) {
      document.getElementById('adAccountsList').textContent = 'No Ad Accounts found.';
      return;
    }
    document.getElementById('adAccountsList').innerHTML = adAccounts.map((a,i)=>{
      return `<strong>${a.name || a.account_id}</strong> (ID: ${a.account_id || a.id}) <button onclick="selectAdAccount(${i})">Select</button><br>`;
    }).join('');
  });
}
window.selectAdAccount = (i) => {
  selectedAdAccount = adAccounts[i];
  document.getElementById('selectedAdAccount').innerText = `Selected Ad Account: ${selectedAdAccount.name || selectedAdAccount.account_id}`;
};

// ad insights
document.getElementById('btnGetAdInsights').onclick = () => {
  if(!selectedAdAccount) return alert('Select an ad account first');
  const datePreset='last_7d';
  const fields='spend,impressions,clicks';
  FB.api(`/${selectedAdAccount.id}/insights`,'GET',{fields,date_preset:datePreset,access_token:userAccessToken}, res => {
    if(!res || res.error) {
      document.getElementById('adInsightsResult').textContent = 'Failed to load ad insights.';
      console.error('AdInsights error', res);
      return;
    }
    if(res.data && res.data.length) {
      const d = res.data[0];
      document.getElementById('adInsightsResult').textContent = JSON.stringify(d, null, 2);
      const metrics = { Spend: d.spend || 0, Impressions: d.impressions || 0, Clicks: d.clicks || 0 };
      if(adChart) adChart.destroy();
      adChart = new Chart(document.getElementById('adChart'), { type:'bar', data:{ labels:Object.keys(metrics), datasets:[{ data:Object.values(metrics), backgroundColor:'#f57c00' }]}});
    } else {
      document.getElementById('adInsightsResult').textContent = 'No insights returned.';
    }
  });
};

// fetch pages
function fetchPages(){
  document.getElementById('pagesList').textContent = 'Loading...';
  FB.api('/me/accounts','GET',{access_token:userAccessToken}, r => {
    if(!r || r.error) {
      document.getElementById('pagesList').textContent = 'Failed to load pages.';
      console.error('Pages error', r);
      return;
    }
    pages = r.data || [];
    if(!pages.length) {
      document.getElementById('pagesList').textContent = 'No Pages found.';
      return;
    }
    document.getElementById('pagesList').innerHTML = pages.map((p,i)=>`<strong>${p.name}</strong> <button onclick="selectPage(${i})">Select</button><br>`).join('');
  });
}
window.selectPage = (i) => {
  selectedPage = pages[i];
  document.getElementById('selectedPageName').textContent = selectedPage.name;
};

// post to page
document.getElementById('btnPost').onclick = () => {
  if(!selectedPage) return alert('Select a page first');
  const msg = document.getElementById('postMessage').value || '';
  fetch(`https://graph.facebook.com/v19.0/${selectedPage.id}/feed`, {
    method:'POST',
    body: new URLSearchParams({ message: msg, access_token: selectedPage.access_token })
  }).then(r=>r.json()).then(d => {
    document.getElementById('postResult').textContent = JSON.stringify(d, null, 2);
  }).catch(e=>{
    console.error(e);
    document.getElementById('postResult').textContent = 'Post failed. See console.';
  });
};

// page insights
document.getElementById('btnGetPageInsights').onclick = () => {
  if(!selectedPage) return alert('Select page first');
  const metric = document.getElementById('insightsMetric').value;
  FB.api(`/${selectedPage.id}/insights`, { metric, period:'days_7', access_token: selectedPage.access_token }, r => {
    if(!r || r.error) { document.getElementById('postResult').textContent='Failed to fetch insights'; console.error(r); return; }
    if(r.data && r.data[0]) {
      const labels = r.data[0].values.map(v=>v.end_time.split('T')[0]);
      const values = r.data[0].values.map(v=>v.value);
      if(pageChart) pageChart.destroy();
      pageChart = new Chart(document.getElementById('pageChart'), { type:'line', data:{ labels, datasets:[{ label: metric, data: values, borderColor:'#4267B2', fill:true, backgroundColor:'rgba(66,103,178,0.18)'}] }});
    } else {
      document.getElementById('postResult').textContent = 'No insights returned.';
    }
  });
};


/* ---------------------------
   INSTAGRAM (via connected page)
   --------------------------- */
document.getElementById('btnGetInstagramInfo').onclick = () => {
  if(!selectedPage) return alert('Select page first');
  FB.api(`/${selectedPage.id}?fields=instagram_business_account`, { access_token: selectedPage.access_token }, r => {
    if(!r || r.error) { document.getElementById('instaInfo').textContent='Error fetching IG account'; console.error(r); return; }
    if(!r.instagram_business_account) { document.getElementById('instaInfo').textContent='No IG account linked to this page.'; return; }
    const igId = r.instagram_business_account.id;
    FB.api(`/${igId}?fields=username,followers_count,media_count,profile_picture_url`, { access_token: selectedPage.access_token }, res => {
      document.getElementById('instaInfo').textContent = JSON.stringify(res, null, 2);
    });
  });
};

// create IG media then publish
document.getElementById('btnInstaPost').onclick = () => {
  if(!selectedPage) return alert('Select page first');
  const img = document.getElementById('instaImageUrl').value.trim();
  const caption = document.getElementById('instaCaption').value || '';
  if(!img) return alert('Provide an image URL for IG post.');
  FB.api(`/${selectedPage.id}?fields=instagram_business_account`, { access_token: selectedPage.access_token }, r => {
    if(!r || !r.instagram_business_account) return alert('No IG linked');
    const igId = r.instagram_business_account.id;
    // create media
    fetch(`https://graph.facebook.com/v19.0/${igId}/media`, {
      method:'POST',
      body: new URLSearchParams({ image_url: img, caption, access_token: selectedPage.access_token })
    }).then(r=>r.json()).then(d => {
      if(d.error) { document.getElementById('instaPostResult').textContent = JSON.stringify(d,null,2); return; }
      // publish
      fetch(`https://graph.facebook.com/v19.0/${igId}/media_publish`, {
        method:'POST',
        body: new URLSearchParams({ creation_id: d.id, access_token: selectedPage.access_token })
      }).then(rr=>rr.json()).then(pub => document.getElementById('instaPostResult').textContent = JSON.stringify(pub,null,2)).catch(e=>{console.error(e); document.getElementById('instaPostResult').textContent='Publish failed';});
    }).catch(e=>{console.error(e); document.getElementById('instaPostResult').textContent='Create media failed';});
  });
};
document.getElementById('btnGetInstaInsights').onclick = () => {
  if (!selectedPage) return alert('Select page first');

  FB.api(`/${selectedPage.id}?fields=instagram_business_account`,
    { access_token: selectedPage.access_token },
    r => {
      if (!r || !r.instagram_business_account) return alert('No IG linked');
      const igId = r.instagram_business_account.id;

      FB.api(
        `/${igId}/insights?metric=reach,profile_views,accounts_engaged,total_interactions,follower_count&period=days_7`,
        { access_token: selectedPage.access_token },
        res => {
          if (!res || res.error) {
            document.getElementById('instaInfo').textContent = '‚ùå Failed to fetch Instagram insights';
            console.error('IG Insights error', res);
            return;
          }

          if (res.data && res.data.length) {
            let summaryHTML = '<h3>üìä Instagram Insights (Last 7 Days)</h3><ul>';
            res.data.forEach(metric => {
              const name = metric.title || metric.name;
              const value = metric.values[0]?.value || 0;
              summaryHTML += `<li><strong>${name}:</strong> ${value}</li>`;
            });
            summaryHTML += '</ul>';
            document.getElementById('instaInfo').innerHTML = summaryHTML;

            const labels = res.data.map(i => i.name.toUpperCase());
            const values = res.data.map(i => i.values[0].value);
            const colors = ['#E1306C', '#FCAF45', '#833AB4', '#0095F6', '#FFCE56'];

            if (instaChart) instaChart.destroy();
            instaChart = new Chart(document.getElementById('instaChart'), {
              type: 'bar',
              data: {
                labels,
                datasets: [{
                  label: 'Instagram Metrics',
                  data: values,
                  backgroundColor: colors.slice(0, values.length),
                  borderRadius: 10
                }]
              },
              options: {
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: 'Instagram Performance (Last 7 Days)', color: '#E1306C' }
                },
                scales: {
                  y: { beginAtZero: true },
                  x: { ticks: { color: '#333' } }
                }
              }
            });
          } else {
            document.getElementById('instaInfo').textContent = 'No Instagram insights returned.';
          }
        }
      );
    }
  );
};



const BACKEND_URL = "https://social-ads-backend.onrender.com";

const CLIENT_ID = "909323253369-817lthmrt17refrp225q39h4nkqsp2tj.apps.googleusercontent.com";
let ytAccessToken = null, ytTokenClient = null;

// Init GAPI client
function gapiInit() {
  gapi.load("client", () => {
    gapi.client.setApiKey("AIzaSyDRV6_ZEnQMdcMIhbhDYJP9OSayla3AV48");
    gapi.client.load("youtube", "v3");
  });
}

window.addEventListener("load", () => {
  gapiInit();
  ytTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/adwords",
    callback: (resp) => {
      ytAccessToken = resp.access_token;
      document.getElementById("ytStatus").textContent = "‚úÖ Logged in";
      document.getElementById("btnGoogleLogin").style.display = "none";
      document.getElementById("btnGoogleLogout").style.display = "inline-block";
    },
  });
});

document.getElementById("btnGoogleLogin").onclick = () => ytTokenClient.requestAccessToken({ prompt: "consent" });
document.getElementById("btnGoogleLogout").onclick = () => location.reload();

// Upload
document.getElementById("uploadForm").onsubmit = async (e) => {
  e.preventDefault();
  if (!ytAccessToken) return alert("Login first.");
  const file = document.getElementById("videoFile").files[0];
  const formData = new FormData();
  formData.append("video", file);
  formData.append("title", document.getElementById("title").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("privacyStatus", document.getElementById("privacy").value);

  const res = await fetch(`${BACKEND_URL}/upload-video`, {
    method: "POST",
    headers: { Authorization: `Bearer ${ytAccessToken}` },
    body: formData,
  });

  const data = await res.json();
  document.getElementById("ytUploadResult").textContent = JSON.stringify(data, null, 2);
};

// Fetch Metrics
document.getElementById("btnFetchMetrics").onclick = async () => {
  const res = await fetch(`${BACKEND_URL}/googleads-metrics`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      developerToken: "aDfTg_put93gcMI_8e293g",
      customerId: "5368806709",
      accessToken: ytAccessToken
    })
  });

  const data = await res.json();
  document.getElementById("metricsResult").textContent = JSON.stringify(data, null, 2);

  const labels = data[0]?.results?.map(r => r.campaign.name) || [];
  const impressions = data[0]?.results?.map(r => r.metrics.impressions) || [];
  const clicks = data[0]?.results?.map(r => r.metrics.clicks) || [];

  new Chart(document.getElementById("ytChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Impressions", data: impressions },
        { label: "Clicks", data: clicks }
      ]
    },
  });
};


</script>
</body>
</html>

